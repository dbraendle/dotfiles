# Scanner Module

Provides command-line shortcuts for scanning documents and photos from desktop Macs with scanner access.

## Overview

This module creates convenient command-line shortcuts for common scanning operations:

- **scan-document**: Scan single documents as PDF (flatbed)
- **scan-photo**: Scan photos in high-resolution as JPG
- **scan-multipage**: Scan multiple pages as PDF using ADF (Automatic Document Feeder)
- **scan-test**: Test scanner connection
- **scan-config**: Show scanner configuration

All scanned files are automatically saved to `~/Documents/Scans/` with timestamps.

## Architecture

The module uses a template-based approach:

1. During installation, you provide your scanner server's hostname/IP
2. The template is rendered with your scanner configuration
3. Scripts are installed to `/usr/local/bin/` as executable commands
4. Scanner host configuration is saved to `~/.scanner-config` (not tracked in repo)

## Files

- `module.json` - Module metadata (desktop-only, optional)
- `install.sh` - Interactive installation with scanner host setup
- `update.sh` - Update shortcuts with current configuration
- `uninstall.sh` - Remove shortcuts and optionally configuration
- `README.md` - This file
- `templates/scan-shortcuts.sh.template` - Scanner script template

## Requirements

### System Requirements

- macOS desktop (not laptop - though can be installed on laptops too)
- Access to a scanner server (hostname or IP)
- Network connection to scanner

### Software Requirements

- **SANE backends**: Required for scanner functionality
  ```bash
  brew install sane-backends
  ```
- **ImageMagick**: Optional, for format conversion (TIFF to PDF/JPG)
  ```bash
  brew install imagemagick
  ```

The installation script will offer to install SANE backends if not present.

## Installation

```bash
./modules/scanner/install.sh
```

The installation process will:

1. Check if you're on a desktop Mac (optional)
2. Prompt for scanner server hostname/IP
3. Save configuration to `~/.scanner-config`
4. Render the template with your scanner host
5. Install commands to `/usr/local/bin/`
6. Check for SANE backends and offer to install if missing
7. Optionally test the scanner connection

### Example Installation

```
Scanner server hostname or IP: scanner.local

Installing scanner shortcuts...
  scan-document
  scan-photo
  scan-multipage
  scan-test
  scan-config

Scanner shortcuts installed successfully!
```

## Usage

### Scan a Document (PDF)

```bash
scan-document
```

Scans a single document using the flatbed scanner:
- Format: PDF
- Resolution: 300 DPI
- Mode: Grayscale
- Output: `~/Documents/Scans/document_YYYYMMDD_HHMMSS.pdf`

### Scan a Photo (High-Res JPG)

```bash
scan-photo
```

Scans a photo in high resolution:
- Format: JPG
- Resolution: 600 DPI
- Mode: Color
- Quality: 95%
- Output: `~/Documents/Scans/photo_YYYYMMDD_HHMMSS.jpg`

### Scan Multiple Pages (ADF)

```bash
scan-multipage
```

Scans multiple pages using the Automatic Document Feeder:
- Format: PDF (multi-page)
- Resolution: 300 DPI
- Mode: Grayscale
- Source: ADF (Automatic Document Feeder)
- Output: `~/Documents/Scans/multipage_YYYYMMDD_HHMMSS.pdf`

The script will prompt you to load documents into the ADF, then scan all pages automatically.

### Test Scanner Connection

```bash
scan-test
```

Tests the connection to your scanner server and lists available scanners.

### Show Configuration

```bash
scan-config
```

Displays current scanner configuration:
- Scanner host
- Scan directory
- Configuration file location
- Available scanners

## Update

```bash
./modules/scanner/update.sh
```

Updates the scanner shortcuts with the current configuration. This is useful if:
- You've updated the template in the dotfiles repo
- You want to ensure all symlinks are correct
- You've manually edited configuration

## Reconfigure Scanner Host

To change the scanner server hostname/IP:

```bash
./modules/scanner/install.sh
```

The installation script will detect existing configuration and offer to reconfigure.

Alternatively, manually edit `~/.scanner-config`:

```bash
nano ~/.scanner-config
```

Then run the update script:

```bash
./modules/scanner/update.sh
```

## Uninstall

```bash
./modules/scanner/uninstall.sh
```

This will:
1. Remove all scanner command shortcuts from `/usr/local/bin/`
2. Optionally remove `~/.scanner-config` (with backup)
3. Note: Scanned files in `~/Documents/Scans/` are preserved

## Configuration

### Scanner Configuration File

Location: `~/.scanner-config`

This file contains your scanner server hostname and is **not tracked** in the dotfiles repository:

```bash
# Scanner configuration
# This file is automatically generated and not tracked in the dotfiles repo
SCANNER_HOST="scanner.local"
```

### Scan Output Directory

All scanned files are saved to: `~/Documents/Scans/`

Files are automatically named with timestamps:
- `document_20251107_143022.pdf`
- `photo_20251107_143045.jpg`
- `multipage_20251107_143110.pdf`

## Troubleshooting

### Scanner Not Found

```bash
scan-test
```

If scanner is not detected:

1. **Check network connection**: Can you ping the scanner server?
   ```bash
   ping scanner.local
   ```

2. **Verify scanner server is running**: Ensure SANE daemon is running on scanner server

3. **Check SANE configuration**: Ensure SANE backends are installed
   ```bash
   brew install sane-backends
   ```

4. **Verify scanner hostname**: Check `~/.scanner-config` has correct hostname

### SANE Backends Not Installed

If you see "scanimage command not found":

```bash
brew install sane-backends
```

### ImageMagick Not Installed

If you see "ImageMagick not found. Saved as TIFF instead":

```bash
brew install imagemagick
```

Without ImageMagick, scans will be saved as TIFF files instead of PDF/JPG.

### Permission Denied

If installation fails with permission errors for `/usr/local/bin/`:

The installation script will automatically use `sudo` when needed. You may be prompted for your password.

### Scanner Connection Issues

1. **Firewall**: Check if firewall is blocking SANE connections (port 6566)
2. **Network scanning**: Ensure network scanning is enabled on scanner
3. **SANE configuration**: Check `/usr/local/etc/sane.d/net.conf` for scanner server

## Advanced Configuration

### Custom SANE Settings

You can customize SANE settings in the template file:

`modules/scanner/templates/scan-shortcuts.sh.template`

Common settings to adjust:
- Resolution: `--resolution=300` (DPI)
- Page size: `--page-width=210 --page-height=297` (A4 in mm)
- Color mode: `--mode=Gray|Color|Lineart`
- Source: `--source=Flatbed|ADF`

After editing, run the update script:

```bash
./modules/scanner/update.sh
```

### Network Scanner Configuration

For network scanners, ensure SANE is configured to find them:

Edit `/usr/local/etc/sane.d/net.conf`:

```
# Add your scanner server
scanner.local
# or
192.168.1.100
```

## Module Metadata

- **Profile**: `desktop` only
- **Category**: `utilities`
- **Optional**: Yes (not installed by default)
- **Dependencies**: None (SANE optional)
- **Platforms**: macOS

## Security Notes

- Scanner configuration (`~/.scanner-config`) is **never committed** to the repository
- Only the template is tracked in the repo
- Scanner host/IP is local to each machine
- No credentials are stored (SANE handles authentication if needed)

## Directory Structure

```
modules/scanner/
├── module.json                          # Metadata
├── install.sh                           # Installation script
├── update.sh                            # Update script
├── uninstall.sh                         # Uninstall script
├── README.md                            # This file
└── templates/
    └── scan-shortcuts.sh.template       # Scanner script template

~/.scanner-config                        # Scanner host config (not in repo)
/usr/local/bin/
├── scan-shortcuts                       # Main script
├── scan-document -> scan-shortcuts      # Symlink
├── scan-photo -> scan-shortcuts         # Symlink
├── scan-multipage -> scan-shortcuts     # Symlink
├── scan-test -> scan-shortcuts          # Symlink
└── scan-config -> scan-shortcuts        # Symlink
```

## See Also

- [SANE Project](http://www.sane-project.org/)
- [SANE Backends Documentation](http://www.sane-project.org/man/sane-net.5.html)
- [ImageMagick Documentation](https://imagemagick.org/)
